version: '3'

services:
  app:
    build: 
      context: .
      dockerfile: Dockerfile
      args:
        # [Choice] Node.js version: 14, 12, 10
        VARIANT: 14
        # On Linux, you may need to update USER_UID and USER_GID below if not your local UID is not 1000.
        USER_UID: 1000
        USER_GID: 1000

    volumes:
      - ..:/workspace:cached

    # Overrides default command so things don't shut down after the process ends.
    command: sleep infinity

    # Runs app on the same network as the database container, allows "forwardPorts" in devcontainer.json function.
    network_mode: service:db
    # networks:
    #   - devnetwork
    # Uncomment the next line to use a non-root user for all processes.
    # user: node

    # Use "forwardPorts" in **devcontainer.json** to forward an app port locally. 
    # (Adding the "ports" property to this file will not forward from a Codespace.)

    environment:
      DATABASE_URL: &MONGO_URL "mongodb://db:27017/rostest"
      S3_ENDPOINT: "minio"
      S3_PORT: 9000
      S3_ACCESS_KEY: &S3_ACCESS_KEY "ros"
      S3_SECRET_KEY: &S3_SECRET_KEY "ciscocisco"
      CERT: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURIRENDQWdTZ0F3SUJBZ0lJSkNiZTNpV0dScll3RFFZSktvWklodmNOQVFFRkJRQXdNVEV2TUMwR0ExVUUKQXhNbWMyVmpkWEpsZEc5clpXNHVjM2x6ZEdWdExtZHpaWEoyYVdObFlXTmpiM1Z1ZEM1amIyMHdIaGNOTWpBdwpPVEkyTURreU1EQTFXaGNOTWpBeE1ERXlNakV6TlRBMVdqQXhNUzh3TFFZRFZRUURFeVp6WldOMWNtVjBiMnRsCmJpNXplWE4wWlcwdVozTmxjblpwWTJWaFkyTnZkVzUwTG1OdmJUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQUQKZ2dFUEFEQ0NBUW9DZ2dFQkFLL2F6eFFVbU5mZE1FWG5nMjhNWmtSVHdDanJ3eHVxVUdFZWo0Z0Z6Q2ZEUURrWgp4RGNvYURHNEFaaUdlZUhQZWVkb08rNGxTR04vd2hnRmp4UHNlY1dnN2d1N29UanNvOVFvSkc4QnZtZW5pWUt2Cm9BdXNIckZNWVJ5TlZQTjZhdHRKaFZPbW9xaTM4aDI4K1BjcU5uRmpqNzFBZFBtUzR1RmhlUzcxZ09BMUFyMEoKbExZQXRyc0U2cm53dUxFOGNGVnV6K3JKamVOOFJYSm4xcTFWWmZVMEY4aWhLbmpSbi91VHRBTGlIR00zaGVNTApFQ0Vqam9WNUZGUzUwZHp1MW4xdTZ5dEFvNjRIZUV4dlQ5N2NNWnluazZCUVJwV3N1d01XdG5OZTFrSE9mcXhxCllFT3JKeE1UeHBleHRzSmVHK0xnWGJsWXJWSWJIbEN1OHlJZXZsVUNBd0VBQWFNNE1EWXdEQVlEVlIwVEFRSC8KQkFJd0FEQU9CZ05WSFE4QkFmOEVCQU1DQjRBd0ZnWURWUjBsQVFIL0JBd3dDZ1lJS3dZQkJRVUhBd0l3RFFZSgpLb1pJaHZjTkFRRUZCUUFEZ2dFQkFGMmIyUnhKVjgvSHdVM0FTVHV4V09oZURaeWFTYS9tcEhaSHBaNnNXOTJTCmFMZEo0a3JDSGlMb0p1QVdVOHpJc0IvKzA3eXQxdC9rYzVwVkNXT3JCbEd6N1NmVWlQM3J6MjNDK1VXZWp1SjEKSEZGTElCbzhBa1c1TTVTTkJBcFEwY0VRYy8rSTlHc3FqR0wxTmJkZ1RaUmI0OXFQYzRMdUJsVTREY1l5cldsWAowTTEvcEpFSVdxQTlBQzArdmdPSVhXaW1wQjQ0YTZBZXUydnplZlV2N1U1NnRwYURDdEc4Njd0Y1QzOS9VbUp6CjI2M2c5dTYwMFB3ZWNIT2dVYWpzbXFTd080NXg4MVA3Mnd1Qjg1RDVTYU9TR3RsNXE2bGRmYWgzSzM4eW04THIKSnZOWHYzREFBZzNvTVN6SVR4citsZGlrNlN5djNJckV3OFgxOUxIZ1Frdz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
    
    depends_on:
      - db
      - minio

  db:
    image: mongo:latest
    restart: unless-stopped
    volumes:
      - mongodb-data:/data/db
    ports:
        - "27017:27017"
    
    # Uncomment to change startup options
    # environment:
    #  MONGO_INITDB_ROOT_USERNAME: root
    #  MONGO_INITDB_ROOT_PASSWORD: example
    #  MONGO_INITDB_DATABASE: your-database-here

    # Add "forwardPorts": ["27017"] to **devcontainer.json** to forward MongoDB locally.
    # (Adding the "ports" property to this file will not forward from a Codespace.)

  minio:
    image: minio/minio
    restart: unless-stopped
    environment:
      MINIO_ACCESS_KEY: *S3_ACCESS_KEY
      MINIO_SECRET_KEY: *S3_SECRET_KEY
    command: server /data
    volumes:
      - minio-data:/data
    ports:
       - "9000:9000"

volumes:
  mongodb-data:
  minio-data:
